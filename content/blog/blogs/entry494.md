---
title: concreteCMS(コンクリ)でレンサバのWAFが原因で一部機能がつかえなくなった話
date: 2022-03-31
pagetype: blog
cateId: cms
hero: thumbnail/2022/entry494.png
tags: ["concrete5"]
description: 久々のコンクリネタです。先日、管理画面からブロック追加などの特定の機能が動かなくなったconcrete5に遭遇しました。サーバーはさくらのレンタルサーバー。おそらく私のように苦悶して、原因を探っている人への救いになればと思いこの記事を書くことにしました。
lead: ["久々のコンクリネタです。先日、管理画面からブロック追加などの特定の機能が動かなくなったconcrete5に遭遇しました。サーバーはさくらのレンタルサーバー。おそらく私のように苦悶して、原因を探っている人への救いになればと思いこの記事を書くことにしました。"]
---
## はじめに。concrete5 は concreteCMS になったよ
![concreteCMS](./images/2022/03/entry494-01.png)

https://www.concretecms.com/

ご存知かもしれませんが、concrete5 は名称が変わり concreteCMS になりました。

<msg txt="大切なことなので2度言います。今はconcreteCMSです!!"></msg>

今はほとんどのCMSで見かけるようになったブロック型CMSの先駆けです。

<msg txt="フォーラムのみなさんも優しくて、質問したらすぐ答えがかえってきたり私をWebディベロッパーに育ててくれたのもconcreteCMS!!"></msg>

最新はバージョン9らしいのでまた記事にまとめようと思います。

## 管理画面に入ると特定のファイルが４０３エラー
管理画面に入ると、更新やブロック追加ができなくなっていました。

Chromeの開発者ツールで確認するとコアにある一部のJSが403エラー（net::ERR_ABORTED 403・アクセス拒否）に。

```
Get [ドメイン]/ccm/assets/localization/core/js net::ERR_ABORTED 403
```

/concrete/以下にあるファイルにはなぜかちゃんとアクセスできている。

これが原因で管理画面のJSの一部が使えなくなっていたことが発覚。

<msg txt="コンクリの管理画面はJSで動いてますからね。たまにテーマの作り方が悪くても管理画面側とテーマ側のJSがコンフリクトして動かなくなることもありますしね。"></msg>

なのにプリティURLの設定を外すともとに戻るという不可思議な現象が起こっていました。

### ズバリ、原因はWAFだった
<strong>403 Forbidden</strong>となりがちなパターンは以下。

* パーミッション
* .htaccessによるアクセス制限
* DNS設定の不備
* サーバー側の障害

一部のファイルが403でアクセスできないのでパーミッションか、リライト系（mod_rewriteとか）の設定ミスでおかしくなっていると当たりをつけましたが、結局はWAF（サーバー側のファイヤーウォール）が原因でした。

> Web Application Firewall（略称:WAF、ワフ）とは、ウェブアプリケーションの脆弱性を悪用した攻撃からウェブアプリケーションを保護するセキュリティ対策の一つ。<br>
> https://ja.wikipedia.org/wiki/Web_Application_Firewall

だいたいこの手の問題が起こるときは.htaccessあたりかと思い、ローカルに同じ環境を再現したのに無事に動く…。

さらに同じサーバーでドメインが違う場所に複製したテスト環境も同様に正常に動く…。

<msg txt="あれ、まてよ…。"></msg>

<br>ふと思い出しました。

<br>さくらのレンタルサーバーは私も昔使っていて、諸々クセがあったことを。

サーバーパネル内でドメインごとの設定を徹底的に比較し、やっと見つけました。

<msg txt="犯人はWAF、お前だったのか！"></msg>

最近はWordPress案件が多く、さくらサーバーからも遠のいていたので原因を突き止めるのに約1日かかりました。。。。

<msg txt="WordPressもブロックエディタになったしね。"></msg>

WAFを解除したら問題なく動くように。

## まとめ・部分的に403エラーが出たらWAFも疑え
こういうWAFが悪さするケースは他のレンタルサーバーでも結構あるみたいです（hetemlとか）。

他にも、<em>.htaccess</em>などの記述ミスで起こることもあるので複合的に検証しないといけませんが、もし同じような現象があったら可能性の一つとして疑ってみてください。


* パーミッション
* .htaccessによるアクセス制限
* DNS設定の不備
* サーバー側の障害

良い勉強になりましたし、今回はコンクリ用のDocker環境を作ったりもしたので、収穫も多かったです。

また、それに関しても記事にしようと思います！

<msg txt="concreteCMS の情報は少ないのでもっと発信していかなければ！"></msg>

この記事が、みなさんのコンクリライフの一助になると幸いです。

最後までお読みいただきありがとうございました。
